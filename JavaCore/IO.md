# 第4节：I/O



## 概念

**同步与异步**

指的是具体通信机制，面向C端。同步时，调用者等待返回结果。异步时，被调用者会通过回调等形式通知调用者。

**阻塞与非阻塞**

指调用者在等待返回结果时的状态，面向B端。阻塞时，调用结果返回前，当前线程会被挂起，并在得到结果之后返回。非阻塞时，如果不能立刻得到结果，该调用不会阻塞当前线程。对于非阻塞情况，调用者需要定时轮询（采用I/O多路复用技术）查看处理状态。

+ 同步阻塞方式，发送方向接收方发送请求后，一直等待响应；
+ 同步非阻塞方式，发送方向接收方发送请求后，一直等待响应；接收方处理请求时进行的IO操作如果不能马上得到结果，就立即返回做其他事情，但是由于没得到请求的处理结果，不响应发送方，发送方一直等待。
+ 异步阻塞方式，发送方向接收请求后，不用等待响应，接着做其他工作；接收方处理请求时进行的IO操作如果不能马上得到结果，就一直等到返回结果后，才响应发送；
+ 异步非阻塞方式，发送方向接收方发送请求后，不用等待响应，可以继续其他工作；接收方处理请求时进行的IO操作如果不能马上得到结果，也不等待，而是去处理其他事情。当IO操作完成以后，将完成状态和结果通知接收方，接收方再响应发送方。

**I/O多路复用**

非阻塞I/O方式下，当I/O没有就绪时，为了及时得到就绪的反馈，需要采用多路复用的机制，又被称为事件驱动模型。事件驱动是指在持续的事务管理过程中，由当前时间点上出现的事件引发的调动可用资源执行相关任务，解决不断出现的问题，防止事务堆积的一种策略。Linux操作系统为例：

+ select 

  首先，创建所关注事件的描述符集合。对于一个描述符，可以关注其上面的读事件，写事件以及异常事件，所以要创建三类事件描述符集合，分别用来收集读事件的描述符、写事件的描述符和异常事件的描述符。

  其次，调用底层提供的select( )函数，等待事件发生。此时，select的阻塞和是否设置非阻塞是没有关系的。

  然后，轮询所有事件描述符集合中的每一个事件描述符，检查是否有相应的事件发生，如果有就进行处理。

+ poll

  poll是针对select优化实现，先创建一个关注事件的描述符集合，再去等待这些事件发生，然后轮询描述符集合，检查有没有事件发生，如果有就处理。

  不同于select需要三个描述集合，poll只需创建一个集合，每个描述符对应的结构上分别设置读事件、写事件和异常事件，轮询时，检查者三种事件是否发生。

+ epoll

  select和poll在描述符比较多的应用中，效率比较低下。

  epoll通过调用通知内核创建一个有N个描述符的事件列表；然后，给这些描述符设置锁关注的事件，并把它添加到内核的事件列表中，在具体的编码过程中也可以通过相关调用对事件列表中描述进行修改和删除。设置完成后，epoll开始等待内核通知事件发生，某一事件发生后，内核将发生事件的描述符列表上报给epoll，进行事件处理。

**Java I/O方式**

+ BIO

  同步阻塞I/O模式，数据的读取写入必须阻塞在一个线程内等待其完成。

  传统BIO（一请求一应答）模型，一般通过在`while(true)` 循环中服务端会调用 `accept()` 方法等待接收客户端的连接的方式监听请求，请求一旦接收到一个连接请求，就可以建立通信套接字在这个通信套接字上进行读写操作，此时不能再接收其他客户端连接请求，只能等待同当前连接的客户端的操作执行完成， 不过可以通过多线程来支持多个客户端的连接。

+ NIO

  NIO是一种同步非阻塞的I/O模型，对应java.nio包，提供了几个核心的组件Channel，Selector和Buffer等抽象。NIO中的N可以理解为Non-blocking，不单纯是New。它支持面向缓冲的，基于通道的I/O操作方法。NIO与IO的区别：

  1、**IO流是阻塞的，NIO流是不阻塞的。**Java NIO使我们可以进行非阻塞IO操作。比如说，单线程中从通道读取数据到buffer，同时可以继续做别的事情，当数据读取到buffer中后，线程再继续处理数据。写数据也是一样的。另外，非阻塞写也是如此。一个线程请求写入一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情。

  2、**IO 面向流(Stream oriented)，而 NIO 面向缓冲区(Buffer oriented)**。在NIO厍中，所有数据都是用缓冲区处理的。在读取数据时，它是直接读到缓冲区中的; 在写入数据时，写入到缓冲区中。任何时候访问NIO中的数据，都是通过缓冲区进行操作。

  3、**Channel (通道)**。NIO 通过Channel（通道） 进行读写。通道是双向的，可读也可写，而流的读写是单向的。无论读写，通道只能和Buffer交互。因为 Buffer，通道可以异步地读写。

  4、**Selectors(选择器)。**NIO有选择器，而IO没有。选择器用于使用单个线程处理多个通道。因此，它需要较少的线程来处理这些通道。线程之间的切换对于操作系统来说是昂贵的。 因此，为了提高系统效率选择器是有用的。

+ AIO

  AIO 也就是 NIO 2。在 Java 7 中引入了 NIO 的改进版 NIO 2,它是异步非阻塞的IO模型。异步 IO 是基于事件和回调机制实现的，也就是应用操作之后会直接返回，不会堵塞在那里，当后台处理完成，操作系统会通知相应的线程进行后续的操作。AIO 是异步IO的缩写，虽然 NIO 在网络操作中，提供了非阻塞的方法，但是 NIO 的 IO 行为还是同步的。目前来说 AIO 的应用还不是很广泛。