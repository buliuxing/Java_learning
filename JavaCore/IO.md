# 第4节：I/O



## 概念

**同步与异步**

指的是具体通信机制，面向C端。同步时，调用者等待返回结果。异步时，被调用者会通过回调等形式通知调用者。

**阻塞与非阻塞**

指调用者在等待返回结果时的状态，面向B端。阻塞时，调用结果返回前，当前线程会被挂起，并在得到结果之后返回。非阻塞时，如果不能立刻得到结果，该调用不会阻塞当前线程。对于非阻塞情况，调用者需要定时轮询（采用I/O多路复用技术）查看处理状态。

+ 同步阻塞方式，发送方向接收方发送请求后，一直等待响应；
+ 同步非阻塞方式，发送方向接收方发送请求后，一直等待响应；接收方处理请求时进行的IO操作如果不能马上得到结果，就立即返回做其他事情，但是由于没得到请求的处理结果，不响应发送方，发送方一直等待。
+ 异步阻塞方式，发送方向接收请求后，不用等待响应，接着做其他工作；接收方处理请求时进行的IO操作如果不能马上得到结果，就一直等到返回结果后，才响应发送；
+ 异步非阻塞方式，发送方向接收方发送请求后，不用等待响应，可以继续其他工作；接收方处理请求时进行的IO操作如果不能马上得到结果，也不等待，而是去处理其他事情。当IO操作完成以后，将完成状态和结果通知接收方，接收方再响应发送方。

**I/O多路复用**

非阻塞I/O方式下，当I/O没有就绪时，为了及时得到就绪的反馈，需要采用多路复用的机制，又被称为事件驱动模型。事件驱动是指在持续的事务管理过程中，由当前时间点上出现的事件引发的调动可用资源执行相关任务，解决不断出现的问题，防止事务堆积的一种策略。Linux操作系统为例：

+ select 

  首先，创建所关注事件的描述符集合。对于一个描述符，可以关注其上面的读事件，写事件以及异常事件，所以要创建三类事件描述符集合，分别用来收集读事件的描述符、写事件的描述符和异常事件的描述符。

  其次，调用底层提供的select( )函数，等待事件发生。此时，select的阻塞和是否设置非阻塞是没有关系的。

  然后，轮询所有事件描述符集合中的每一个事件描述符，检查是否有相应的事件发生，如果有就进行处理。

+ poll

  poll是针对select优化实现，先创建一个关注事件的描述符集合，再去等待这些事件发生，然后轮询描述符集合，检查有没有事件发生，如果有就处理。

  不同于select需要三个描述集合，poll只需创建一个集合，每个描述符对应的结构上分别设置读事件、写事件和异常事件，轮询时，检查者三种事件是否发生。

+ epoll

  select和poll在描述符比较多的应用中，效率比较低下。

  epoll通过调用通知内核创建一个有N个描述符的事件列表；然后，给这些描述符设置锁关注的事件，并把它添加到内核的事件列表中，在具体的编码过程中也可以通过相关调用对事件列表中描述进行修改和删除。设置完成后，epoll开始等待内核通知事件发生，某一事件发生后，内核将发生事件的描述符列表上报给epoll，进行事件处理。

**Java I/O方式**

+ BIO
+ NIO
+ AIO